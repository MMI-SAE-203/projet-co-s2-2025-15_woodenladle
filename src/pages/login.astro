---
import Layout from "../layouts/Layout.astro";
import LoginForm from "../components/LoginForm.astro";
import { deleteUser, updateUser } from "../../backend/backend.mjs";

let error = "";
let success = "";
let newPseudo = "";
let newAvatarUrl = "";

// Mise à jour profil (pseudo et/ou avatar)
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();

    if (formData.get("action") === "update-profile") {
        try {
            const id = formData.get("id");
            const pseudo = formData.get("pseudo");
            const avatar = formData.get("avatar");
            const userData = {};
            if (pseudo) userData.pseudo = pseudo;
            if (avatar && avatar.size > 0) userData.avatar = avatar;

            const updated = await updateUser(id, userData);
            success = "Profil mis à jour !";
            newPseudo = updated.pseudo || "";
            newAvatarUrl = updated.avatar
                ? `https://savoury-road.mathis-guellati.fr/api/files/users/${updated.id}/${updated.avatar}?thumb=100x100`
                : "";
        } catch (e) {
            error = "Erreur lors de la mise à jour du profil.";
        }
    }

    // Suppression de compte
    if (formData.get("action") === "delete-account") {
        try {
            await deleteUser(formData.get("id"));
            success = "Compte supprimé !";
        } catch (e) {
            error = "Erreur lors de la suppression du compte.";
        }
    }
}
---

<Layout>
    <div class="flex flex-col gap-6 text-black">
        <div
            id="login-title"
            class="w-full h-[250px] bg-gray-100 p-0 rounded-b-3xl flex items-center justify-center border-b"
        >
            <h1
                class="text-[80px] font-lilitaone pt-20 text-white [-webkit-text-stroke:1px_black]"
            >
                Se connecter
            </h1>
        </div>
        <div id="login-section">
            <LoginForm />
        </div>

        <div id="connected-section" class="hidden flex flex-col gap-6">
            <h2 class="text-2xl font-bold">Mon compte</h2>
            <p id="connected-email" class="text-lg"></p>
            <img id="connected-avatar" class="w-24 h-24 rounded-full border" />

            <!-- Formulaire pour modifier pseudo et avatar -->
            <form
                id="profile-form"
                method="POST"
                enctype="multipart/form-data"
                class="flex flex-col gap-4"
            >
                <input type="hidden" name="action" value="update-profile" />
                <input type="hidden" name="id" id="profile-user-id" />

                <label>
                    Nouveau pseudo :
                    <input
                        type="text"
                        name="pseudo"
                        id="pseudo-input"
                        class="border px-2 py-1 rounded"
                        autocomplete="off"
                        value={newPseudo}
                    />
                </label>
                <label>
                    Nouvel avatar :
                    <input type="file" name="avatar" accept="image/*" />
                </label>
                <button
                    type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
                >
                    Mettre à jour mon profil
                </button>
            </form>

            <button
                id="logout-btn"
                class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition"
            >
                Se déconnecter
            </button>

            <!-- Suppression compte : submit le formulaire caché -->
            <form id="delete-account-form" method="POST" style="display:none;">
                <input type="hidden" name="action" value="delete-account" />
                <input type="hidden" name="id" id="delete-user-id" />
            </form>
            <button
                id="delete-account-btn"
                class="bg-red-800 text-white px-4 py-2 rounded hover:bg-red-900 transition"
            >
                Supprimer mon compte
            </button>
        </div>

        {success && <p class="text-green-600">{success}</p>}
        {error && <p class="text-red-600">{error}</p>}
    </div>

    <script is:browser>
        window.addEventListener("DOMContentLoaded", () => {
            const user = JSON.parse(localStorage.getItem("user"));
            const loginSection = document.getElementById("login-section");
            const loginTitle = document.getElementById("login-title");
            const connectedSection = document.getElementById("connected-section");
            const connectedEmail = document.getElementById("connected-email");
            const connectedAvatar = document.getElementById("connected-avatar");
            const logoutBtn = document.getElementById("logout-btn");
            const deleteAccountBtn = document.getElementById("delete-account-btn");
            const deleteAccountForm = document.getElementById("delete-account-form");
            const deleteUserId = document.getElementById("delete-user-id");

            // Formulaire de maj du profil
            const profileForm = document.getElementById("profile-form");
            const pseudoInput = document.getElementById("pseudo-input");
            const profileUserId = document.getElementById("profile-user-id");

            if (user?.email) {
                // Affichage connecté
                loginSection.classList.add("hidden");
                connectedSection.classList.remove("hidden");
                loginTitle.classList.add("hidden");

                connectedEmail.textContent = "Connecté en tant que : " + user.email;
                if (user.avatar) {
                    connectedAvatar.src = `https://savoury-road.mathis-guellati.fr/api/files/users/${user.id}/${user.avatar}?thumb=100x100`;
                }
                if (user.pseudo && pseudoInput) {
                    pseudoInput.value = user.pseudo;
                }
                if (profileUserId) {
                    profileUserId.value = user.id;
                }

                // Déconnexion
                logoutBtn.addEventListener("click", () => {
                    localStorage.removeItem("user");
                    window.location.reload();
                });

                deleteAccountBtn.addEventListener("click", () => {
                    const confirmed = confirm("Es-tu sûr de vouloir supprimer ton compte ?");
                    if (!confirmed) return;
                    deleteUserId.value = user.id;
                    deleteAccountForm.submit();
                });
            }
        });
    </script>
</Layout>
